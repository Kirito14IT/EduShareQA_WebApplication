# 邮件认证失败问题解决方案

## 问题描述

忘记密码功能出现错误："验证码发送失败，请稍后重试: Authentication failed"

## 根本原因

QQ邮箱SMTP服务器认证失败，通常由以下原因造成：

1. **环境变量未设置** - `MAIL_USERNAME` 和 `MAIL_PASSWORD` 未配置
2. **SMTP服务未开启** - QQ邮箱的SMTP服务未开启
3. **授权码错误** - 使用了QQ密码而不是16位授权码
4. **网络问题** - 无法连接到QQ邮箱SMTP服务器

## 解决方案

### 方案一：使用配置脚本（推荐）

#### 1. 开启QQ邮箱SMTP服务

1. 登录 [QQ邮箱网页版](https://mail.qq.com)
2. 点击右上角 **设置** 图标 → **账户**
3. 找到 **SMTP服务**，点击 **开启**
4. 按照提示发送短信验证并开启服务
5. 系统会提供一个 **16位授权码**，请保存好

#### 2. 运行配置脚本

双击运行 `setup-email.bat` 文件：

```cmd
setup-email.bat
```

按照提示输入：
- QQ邮箱地址（如：`2657751462@qq.com`）
- 16位授权码（不是QQ密码！）

#### 3. 重启应用

配置完成后，重启Spring Boot应用：

```bash
# 停止当前应用 (Ctrl+C)
mvn spring-boot:run
```

### 方案二：手动配置环境变量

#### Windows系统

```cmd
# 设置环境变量（管理员权限运行命令提示符）
setx MAIL_USERNAME "2657751462@qq.com" /M
setx MAIL_PASSWORD "你的16位授权码" /M

# 重启命令提示符窗口
```

#### Linux/Mac系统

```bash
export MAIL_USERNAME="2657751462@qq.com"
export MAIL_PASSWORD="你的16位授权码"
```

### 方案三：临时测试

启动应用时直接指定参数：

```bash
java -DMAIL_USERNAME=2657751462@qq.com -DMAIL_PASSWORD=你的16位授权码 -jar target/edushareqa-backend-1.0.0.jar
```

## 测试配置

### 1. 测试邮件发送

```bash
curl -X POST "http://localhost:8080/api/auth/test-email?email=test@example.com"
```

### 2. 测试忘记密码

1. 访问登录页面
2. 点击"忘记密码？"
3. 输入邮箱：`2657751462@qq.com`
4. 点击"发送验证码"
5. 检查邮箱是否收到邮件

## 常见错误及解决

### 错误：Authentication failed

**原因**：邮箱或授权码错误
**解决**：
- 确认使用16位授权码，不是QQ密码
- 检查邮箱地址是否正确
- 确认SMTP服务已开启

### 错误：connect timed out

**原因**：网络连接问题
**解决**：
- 检查网络连接
- 确认防火墙未阻止SMTP端口(587)
- 尝试更换网络环境

### 错误：535 Authenticate failed

**原因**：授权码错误或过期
**解决**：
- 重新生成授权码
- 确认授权码长度为16位
- 检查是否有特殊字符

## 邮件配置验证

配置完成后，你应该收到类似这样的邮件：

```
主题：EduShareQA 密码重置验证码

亲爱的EduShareQA用户：

您正在进行密码重置操作。

您的验证码是：123456

验证码有效期为15分钟，请及时完成密码重置。

如果这不是您本人的操作，请忽略此邮件。

EduShareQA团队
```

## 安全提醒

- **不要将授权码提交到代码仓库**
- **定期更换授权码**
- **授权码泄露后及时重新生成**
- **使用环境变量而不是硬编码配置**

## 获取帮助

如果问题仍然存在：

1. 检查应用日志中的详细错误信息
2. 确认QQ邮箱SMTP服务状态
3. 联系技术支持并提供错误日志
